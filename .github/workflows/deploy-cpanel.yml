name: Deploy to cPanel

# Se ejecuta automÃ¡ticamente cuando haces push a la rama main
on:
  push:
    branches:
      - main
  # TambiÃ©n puedes ejecutarlo manualmente desde GitHub
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Descargar el cÃ³digo del repositorio
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      # 2. Configurar Node.js
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. Instalar dependencias
      - name: ğŸ“¦ Instalar dependencias
        run: npm ci

      # 4. Compilar el proyecto (crear carpeta dist/)
      - name: ğŸ—ï¸ Build proyecto
        run: npm run build
        env:
          # Variables de entorno para el build (si las necesitas)
          NODE_ENV: production

      # 5. Verificar que el build se creÃ³ correctamente
      - name: âœ… Verificar build
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Error: La carpeta dist no se generÃ³"
            exit 1
          fi
          echo "âœ… Build generado correctamente"
          ls -la dist/

      # 6. Subir archivos a cPanel vÃ­a FTP
      - name: ğŸš€ Deploy a cPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          # Estas variables las configurarÃ¡s en GitHub Secrets
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          
          # Carpeta local que se subirÃ¡ (la compilada)
          local-dir: ./dist/
          
          # Carpeta remota en tu cPanel (ajusta segÃºn tu necesidad)
          server-dir: ${{ secrets.FTP_SERVER_DIR || '/public_html/' }}
          
          # Configuraciones importantes
          dangerous-clean-slate: false  # NO borra todo antes de subir (mÃ¡s seguro)
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.vscode/**
            **/.DS_Store
          
          # Opciones de seguridad
          security: strict
          
          # Timeout en segundos
          timeout: 600000

      # 7. NotificaciÃ³n de Ã©xito
      - name: âœ… Deploy completado
        if: success()
        run: |
          echo "ğŸ‰ Â¡Deploy exitoso a cPanel!"
          echo "ğŸŒ Tu sitio estÃ¡ actualizado"
          echo "â° Fecha: $(date)"

      # 8. NotificaciÃ³n de error
      - name: âŒ Deploy fallÃ³
        if: failure()
        run: |
          echo "âŒ Hubo un error en el deploy"
          echo "Revisa los logs arriba para mÃ¡s detalles"
