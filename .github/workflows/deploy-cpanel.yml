name: Deploy to cPanel

# Se ejecuta automÃ¡ticamente cuando haces push a la rama main
on:
  push:
    branches:
      - main
  # TambiÃ©n puedes ejecutarlo manualmente desde GitHub
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Descargar el cÃ³digo del repositorio
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      # 2. Configurar Node.js
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. Instalar dependencias
      - name: ğŸ“¦ Instalar dependencias
        run: npm ci

      # 4. Compilar el proyecto React (crear carpeta dist/ con subfolder gestion/)
      - name: ğŸ—ï¸ Build proyecto React
        run: npm run build
        env:
          NODE_ENV: production

      # 5. Verificar que el build se creÃ³ correctamente
      - name: âœ… Verificar build
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Error: La carpeta dist no se generÃ³"
            exit 1
          fi
          echo "âœ… Build generado correctamente"
          ls -la dist/

      # 6. Preparar estructura de deploy con sitio pÃºblico
      - name: ğŸ“¦ Preparar estructura de deploy
        run: |
          echo "ğŸ“ Creando estructura de deploy..."
          mkdir -p deploy-temp
          
          # Copiar el sitio pÃºblico (index.html + logo) a la raÃ­z
          echo "ğŸ“„ Copiando sitio pÃºblico..."
          cp public-site/index.html deploy-temp/
          cp public-site/logo.jpg deploy-temp/
          
          # Copiar la aplicaciÃ³n React a la carpeta gestion/
          echo "âš›ï¸  Copiando aplicaciÃ³n React..."
          cp -r dist deploy-temp/gestion
          
          echo "âœ… Estructura preparada:"
          ls -la deploy-temp/
          echo ""
          echo "ğŸ“‚ Contenido de gestion/:"
          ls -la deploy-temp/gestion/

      # 7. Subir sitio pÃºblico (index.html + logo) a raÃ­z de cPanel
      - name: ğŸš€ Deploy sitio pÃºblico a raÃ­z
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          
          # Subir solo el sitio pÃºblico a la raÃ­z
          local-dir: deploy-temp/
          server-dir: ./
          
          # NO usar dangerous-clean-slate aquÃ­ porque solo queremos actualizar archivos especÃ­ficos
          dangerous-clean-slate: false
          
          exclude: |
            **/gestion/**
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.vscode/**
            **/.DS_Store
          
          security: strict
          timeout: 600000

      # 8. Subir aplicaciÃ³n React a carpeta /gestion/
      - name: ğŸš€ Deploy aplicaciÃ³n React a /gestion/
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          
          # Subir contenido de gestion/ a la carpeta remota /gestion/
          local-dir: deploy-temp/gestion/
          server-dir: ./gestion/
          
          # Limpiar solo la carpeta gestion/ antes de subir
          dangerous-clean-slate: true
          
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.vscode/**
            **/.DS_Store
          
          security: strict
          timeout: 600000

      # 7. NotificaciÃ³n de Ã©xito
      - name: âœ… Deploy completado
        if: success()
        run: |
          echo "ğŸ‰ Â¡Deploy exitoso a cPanel!"
          echo "ğŸŒ Tu sitio estÃ¡ actualizado"
          echo "â° Fecha: $(date)"

      # 8. NotificaciÃ³n de error
      - name: âŒ Deploy fallÃ³
        if: failure()
        run: |
          echo "âŒ Hubo un error en el deploy"
          echo "Revisa los logs arriba para mÃ¡s detalles"
