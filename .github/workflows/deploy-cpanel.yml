name: Deploy to cPanel

# Se ejecuta autom√°ticamente cuando haces push a la rama main
on:
  push:
    branches:
      - main
  # Tambi√©n puedes ejecutarlo manualmente desde GitHub
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Descargar el c√≥digo del repositorio
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4

      # 2. Configurar Node.js
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. Instalar dependencias
      - name: üì¶ Instalar dependencias
        run: npm ci

      # 4. Compilar el proyecto React (crear carpeta dist/ con subfolder gestion/)
      - name: üèóÔ∏è Build proyecto React
        run: npm run build
        env:
          NODE_ENV: production

      # 5. Verificar que el build se cre√≥ correctamente
      - name: ‚úÖ Verificar build
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Error: La carpeta dist no se gener√≥"
            exit 1
          fi
          echo "‚úÖ Build generado correctamente"
          ls -la dist/

      # 6. Preparar estructura de deploy con sitio p√∫blico
      - name: üì¶ Preparar estructura de deploy
        run: |
          echo "üìÅ Creando estructura de deploy..."
          mkdir -p deploy-temp
          
          # Copiar el sitio p√∫blico (index.html + logo) a la ra√≠z
          echo "üìÑ Copiando sitio p√∫blico..."
          cp public-site/index.html deploy-temp/
          cp public-site/logo.jpg deploy-temp/
          
          # Copiar la aplicaci√≥n React a la carpeta gestion/
          echo "‚öõÔ∏è  Copiando aplicaci√≥n React..."
          cp -r dist deploy-temp/gestion
          
          echo "‚úÖ Estructura preparada:"
          ls -la deploy-temp/
          echo ""
          echo "üìÇ Contenido de gestion/:"
          ls -la deploy-temp/gestion/

      # 7. Subir sitio p√∫blico (index.html + logo) a ra√≠z de cPanel
      - name: üöÄ Deploy sitio p√∫blico a ra√≠z
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          
          # Subir solo el sitio p√∫blico a la ra√≠z
          local-dir: deploy-temp/
          server-dir: ./
          
          # NO usar dangerous-clean-slate aqu√≠ porque solo queremos actualizar archivos espec√≠ficos
          dangerous-clean-slate: false
          
          exclude: |
            **/gestion/**
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.vscode/**
            **/.DS_Store
          
          security: strict
          timeout: 600000

      # 8. Subir aplicaci√≥n React a carpeta /gestion/
      - name: üöÄ Deploy aplicaci√≥n React a /gestion/
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          
          # Subir contenido de gestion/ a la carpeta remota /gestion/
          local-dir: deploy-temp/gestion/
          server-dir: ./gestion/
          
          # Limpiar solo la carpeta gestion/ antes de subir
          dangerous-clean-slate: true
          
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.vscode/**
            **/.DS_Store
          
          security: strict
          timeout: 600000

      # 9. Subir Backend PHP a /gestion/backend-php/
      - name: üêò Deploy Backend PHP a /gestion/backend-php/
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          
          # Subir backend PHP
          local-dir: backend-php/
          server-dir: ./gestion/backend-php/
          
          # LIMPIAR para eliminar archivos viejos (pero .env est√° excluido, no se borra)
          dangerous-clean-slate: true
          
          exclude: |
            **/.git
            **/.github/**
            **/.gitignore
            **/node_modules/**
            **/.vscode/**
            **/.DS_Store
            **/.env
            **/.env.example
            **/INSTALACION-BACKEND-PHP.md
          
          # Configuraci√≥n de reintentos y timeouts m√°s agresiva
          log-level: verbose
          security: loose
          timeout: 900000

      # 10. Subir .htaccess del backend (workaround para archivos con punto)
      - name: üìÑ Upload backend .htaccess
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          
          # Subir SOLO el .htaccess del backend
          local-dir: backend-php/
          server-dir: ./gestion/backend-php/
          
          dangerous-clean-slate: false
          
          # Incluir SOLO .htaccess, excluir todo lo dem√°s
          exclude: |
            **/*
            !**/.htaccess
          
          log-level: verbose
          security: loose
          timeout: 300000

      # 11. Subir .htaccess del frontend para manejar rutas React Router
      - name: üìÑ Upload frontend .htaccess (React Router)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          
          # Subir .htaccess del frontend a /gestion/
          local-dir: frontend-htaccess/
          server-dir: ./gestion/
          
          dangerous-clean-slate: false
          
          # Incluir SOLO .htaccess
          exclude: |
            **/*
            !**/.htaccess
          
          log-level: verbose
          security: loose
          timeout: 300000

      # 12. Notificaci√≥n de √©xito
      - name: ‚úÖ Deploy completado
        if: success()
        run: |
          echo "üéâ ¬°Deploy exitoso a cPanel!"
          echo "üåê Tu sitio est√° actualizado"
          echo "‚è∞ Fecha: $(date)"

      # 13. Notificaci√≥n de error
      - name: ‚ùå Deploy fall√≥
        if: failure()
        run: |
          echo "‚ùå Hubo un error en el deploy"
          echo "Revisa los logs arriba para m√°s detalles"
